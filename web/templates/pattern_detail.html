{% extends "base.html" %}

{% block title %}Pattern Details - Regex Intelligence Exchange{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('main.search') }}">Search</a></li>
                <li class="breadcrumb-item active" aria-current="page">Pattern Details</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h1 id="pattern-title">Loading pattern...</h1>
                <div>
                    <button class="btn btn-outline-primary" id="test-pattern-btn">
                        <i class="fas fa-vial"></i> Test Pattern
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="pattern-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading pattern details...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Pattern Modal -->
<div class="modal fade" id="testPatternModal" tabindex="-1" aria-labelledby="testPatternModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testPatternModalLabel">Test Pattern</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="test-input" class="form-label">Input Text</label>
                    <textarea class="form-control" id="test-input" rows="5" 
                              placeholder="Enter text to test against this pattern..."></textarea>
                </div>
                <button class="btn btn-primary" id="run-test-btn">
                    <i class="fas fa-play"></i> Run Test
                </button>
                <div id="test-results" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Utility function for escaping HTML
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // Get vendor and product from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const vendor = urlParams.get('vendor') || '{{ vendor }}';
    const product = urlParams.get('product') || '{{ product }}';
    
    // Fetch pattern details
    fetch(`/api/patterns/${vendor}/${product}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                document.getElementById('pattern-content').innerHTML = 
                    `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            // Update page title
            document.getElementById('pattern-title').textContent = `${data.vendor} - ${data.product}`;
            
            // Create pattern details HTML
            const patternHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h5>Pattern Information</h5>
                        <table class="table table-striped">
                            <tr>
                                <th>Vendor</th>
                                <td>${escapeHtml(data.vendor)}</td>
                            </tr>
                            <tr>
                                <th>Product</th>
                                <td>${escapeHtml(data.product)}</td>
                            </tr>
                            <tr>
                                <th>Vendor ID</th>
                                <td>${escapeHtml(data.vendor_id)}</td>
                            </tr>
                            <tr>
                                <th>Product ID</th>
                                <td>${escapeHtml(data.product_id)}</td>
                            </tr>
                            <tr>
                                <th>Category</th>
                                <td>${escapeHtml(data.category)}</td>
                            </tr>
                            <tr>
                                <th>Subcategory</th>
                                <td>${escapeHtml(data.subcategory || 'N/A')}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Metadata</h5>
                        <table class="table table-striped">
                            <tr>
                                <th>Author</th>
                                <td>${escapeHtml(data.all_versions && data.all_versions[0] ? data.all_versions[0].metadata.author : 'N/A')}</td>
                            </tr>
                            <tr>
                                <th>Created</th>
                                <td>${escapeHtml(data.all_versions && data.all_versions[0] ? data.all_versions[0].metadata.created_at : 'N/A')}</td>
                            </tr>
                            <tr>
                                <th>Updated</th>
                                <td>${escapeHtml(data.all_versions && data.all_versions[0] ? data.all_versions[0].metadata.updated_at : 'N/A')}</td>
                            </tr>
                            <tr>
                                <th>Source</th>
                                <td>${escapeHtml(data.all_versions && data.all_versions[0] ? data.all_versions[0].metadata.source : 'N/A')}</td>
                            </tr>
                            <tr>
                                <th>License</th>
                                <td>${escapeHtml(data.all_versions && data.all_versions[0] ? data.all_versions[0].metadata.license : 'N/A')}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <h5>Pattern Details</h5>
                        <div class="accordion" id="patternsAccordion">
                            ${data.all_versions && data.all_versions.length > 0 ? `
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingAllVersions">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                                data-bs-target="#collapseAllVersions" aria-expanded="true" 
                                                aria-controls="collapseAllVersions">
                                            All Versions Patterns (${data.all_versions.length})
                                        </button>
                                    </h2>
                                    <div id="collapseAllVersions" class="accordion-collapse collapse show" 
                                         aria-labelledby="headingAllVersions">
                                        <div class="accordion-body">
                                            ${data.all_versions.map((pattern, index) => `
                                                <div class="card mb-3">
                                                    <div class="card-header">
                                                        <strong>${escapeHtml(pattern.name || 'Unnamed Pattern')}</strong>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <p><strong>Pattern:</strong></p>
                                                                <pre class="bg-light p-2">${escapeHtml(pattern.pattern)}</pre>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <p><strong>Details:</strong></p>
                                                                <ul>
                                                                    <li><strong>Priority:</strong> ${pattern.priority}</li>
                                                                    <li><strong>Confidence:</strong> ${pattern.confidence}</li>
                                                                    <li><strong>Version Group:</strong> ${pattern.version_group}</li>
                                                                </ul>
                                                                ${pattern.metadata ? `
                                                                    <p><strong>Metadata:</strong></p>
                                                                    <ul>
                                                                        <li><strong>Description:</strong> ${escapeHtml(pattern.metadata.description || 'N/A')}</li>
                                                                        <li><strong>Severity:</strong> ${escapeHtml(pattern.metadata.severity || 'N/A')}</li>
                                                                        <li><strong>CVSS Score:</strong> ${pattern.metadata.cvss_score || 'N/A'}</li>
                                                                        ${pattern.metadata.cwe_ids && pattern.metadata.cwe_ids.length > 0 ? 
                                                                          `<li><strong>CWE IDs:</strong> ${escapeHtml(pattern.metadata.cwe_ids.join(', '))}</li>` : ''}
                                                                        ${pattern.metadata.affected_versions && pattern.metadata.affected_versions.length > 0 ? 
                                                                          `<li><strong>Affected Versions:</strong> ${escapeHtml(pattern.metadata.affected_versions.join(', '))}</li>` : ''}
                                                                    </ul>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${data.versions && Object.keys(data.versions).length > 0 ? `
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingVersions">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                data-bs-target="#collapseVersions" aria-expanded="false" 
                                                aria-controls="collapseVersions">
                                            Version-Specific Patterns (${Object.keys(data.versions).length})
                                        </button>
                                    </h2>
                                    <div id="collapseVersions" class="accordion-collapse collapse" 
                                         aria-labelledby="headingVersions">
                                        <div class="accordion-body">
                                            ${Object.entries(data.versions).map(([version, patterns]) => `
                                                <div class="card mb-3">
                                                    <div class="card-header">
                                                        <strong>Version: ${escapeHtml(version)}</strong>
                                                    </div>
                                                    <div class="card-body">
                                                        ${patterns.map((pattern, index) => `
                                                            <div class="mb-3">
                                                                <p><strong>Pattern ${index + 1}:</strong></p>
                                                                <pre class="bg-light p-2">${escapeHtml(pattern.pattern)}</pre>
                                                                <ul>
                                                                    <li><strong>Name:</strong> ${escapeHtml(pattern.name || 'N/A')}</li>
                                                                    <li><strong>Priority:</strong> ${pattern.priority}</li>
                                                                    <li><strong>Confidence:</strong> ${pattern.confidence}</li>
                                                                    <li><strong>Version Group:</strong> ${pattern.version_group}</li>
                                                                </ul>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('pattern-content').innerHTML = patternHtml;
        })
        .catch(error => {
            console.error('Error fetching pattern details:', error);
            document.getElementById('pattern-content').innerHTML = 
                `<div class="alert alert-danger">Error loading pattern details: ${error.message}</div>`;
        });
    
    // Test pattern functionality
    document.getElementById('test-pattern-btn').addEventListener('click', function() {
        const testModal = new bootstrap.Modal(document.getElementById('testPatternModal'));
        testModal.show();
    });
    
    document.getElementById('run-test-btn').addEventListener('click', function() {
        const inputText = document.getElementById('test-input').value;
        const vendor = urlParams.get('vendor') || '{{ vendor }}';
        const product = urlParams.get('product') || '{{ product }}';
        
        if (!inputText.trim()) {
            document.getElementById('test-results').innerHTML = 
                '<div class="alert alert-warning">Please enter some text to test.</div>';
            return;
        }
        
        // Show loading indicator
        document.getElementById('test-results').innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Testing...</span>
                </div>
                <p>Testing pattern against input text...</p>
            </div>
        `;
        
        fetch('/api/match', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: inputText
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Filter results to only show matches for this specific pattern
            const patternMatches = data.filter(match => 
                match.vendor_id === vendor && match.product_id === product
            );
            
            if (patternMatches.length === 0) {
                document.getElementById('test-results').innerHTML = 
                    '<div class="alert alert-info">No matches found for this specific pattern.</div>';
                return;
            }
            
            // Advanced pattern testing results with more details
            const resultsHtml = `
                <div class="alert alert-success">
                    <h5>Found ${patternMatches.length} match${patternMatches.length !== 1 ? 'es' : ''}!</h5>
                    <p>Matches for this pattern:</p>
                </div>
                
                <div class="accordion" id="testResultsAccordion">
                    ${patternMatches.map((match, index) => `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-${index}">
                                <button class="accordion-button${index === 0 ? '' : ' collapsed'}" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#collapse-${index}" aria-expanded="${index === 0 ? 'true' : 'false'}" 
                                        aria-controls="collapse-${index}">
                                    ${escapeHtml(match.vendor)} - ${escapeHtml(match.product)} 
                                    ${match.version ? `<span class="badge bg-primary ms-2">Version: ${escapeHtml(match.version)}</span>` : ''}
                                </button>
                            </h2>
                            <div id="collapse-${index}" class="accordion-collapse collapse${index === 0 ? ' show' : ''}" 
                                 aria-labelledby="heading-${index}">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Match Details</h6>
                                            <ul class="list-unstyled">
                                                <li><strong>Pattern Name:</strong> ${escapeHtml(match.pattern_name)}</li>
                                                <li><strong>Vendor ID:</strong> ${escapeHtml(match.vendor_id)}</li>
                                                <li><strong>Product ID:</strong> ${escapeHtml(match.product_id)}</li>
                                                ${match.version_range ? `<li><strong>Version Range:</strong> ${escapeHtml(match.version_range)}</li>` : ''}
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Matched Text</h6>
                                            <pre class="bg-light p-2">${escapeHtml(match.matched_text)}</pre>
                                        </div>
                                    </div>
                                    
                                    ${match.version ? `
                                        <div class="mt-3">
                                            <h6>Version Information</h6>
                                            <div class="alert alert-info">
                                                <strong>Detected Version:</strong> ${escapeHtml(match.version)}
                                                ${match.version_range ? `<br><strong>Version Range:</strong> ${escapeHtml(match.version_range)}` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#raw-results" aria-expanded="false" aria-controls="raw-results">
                        <i class="fas fa-code"></i> Show Raw Results
                    </button>
                    <div class="collapse mt-2" id="raw-results">
                        <div class="card card-body">
                            <pre class="mb-0">${escapeHtml(JSON.stringify(patternMatches, null, 2))}</pre>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('test-results').innerHTML = resultsHtml;
        })
        .catch(error => {
            console.error('Error testing pattern:', error);
            document.getElementById('test-results').innerHTML = 
                `<div class="alert alert-danger">Error testing pattern: ${error.message}</div>`;
        });
    });
</script>
{% endblock %}
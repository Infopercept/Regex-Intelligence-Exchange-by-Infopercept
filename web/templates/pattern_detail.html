{% extends "base.html" %}

{% block title %}Pattern Details - Regex Intelligence Exchange{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('main.search') }}">Search</a></li>
                <li class="breadcrumb-item active" aria-current="page">Pattern Details</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h1 id="pattern-title">Loading pattern...</h1>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" id="test-pattern-btn">
                        <i class="fas fa-vial"></i> Test Pattern
                    </button>
                    <button class="btn btn-outline-secondary" id="copy-pattern-btn">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="pattern-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading pattern details...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Pattern Modal -->
<div class="modal fade" id="testPatternModal" tabindex="-1" aria-labelledby="testPatternModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testPatternModalLabel">Test Pattern</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="test-input" class="form-label">Input Text</label>
                    <textarea class="form-control" id="test-input" rows="5" 
                              placeholder="Enter text to test against this pattern..."></textarea>
                    <div class="form-text">Paste HTML, HTTP headers, or other text content to test against this pattern.</div>
                </div>
                <div class="mb-3">
                    <button class="btn btn-primary" id="run-test-btn">
                        <i class="fas fa-play"></i> Run Test
                    </button>
                    <button class="btn btn-outline-secondary" id="clear-test-btn">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                <div id="test-results" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Copy Success Modal -->
<div class="modal fade" id="copySuccessModal" tabindex="-1" aria-labelledby="copySuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                <p class="mb-0">Pattern copied to clipboard!</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Utility function for escaping HTML
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // Get vendor and product from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const vendor = urlParams.get('vendor') || '{{ vendor }}';
    const product = urlParams.get('product') || '{{ product }}';
    
    // Fetch pattern details
    fetch(`/api/patterns/${vendor}/${product}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                document.getElementById('pattern-content').innerHTML = 
                    `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            // Update page title
            document.getElementById('pattern-title').textContent = `${data.vendor} - ${data.product}`;
            
            // Create pattern details HTML
            const patternHtml = `
                <div class="row">
                    <div class="col-lg-6">
                        <h3>Pattern Information</h3>
                        <table class="table table-striped pattern-metadata-table">
                            <tr>
                                <th>Vendor</th>
                                <td>${escapeHtml(data.vendor)}</td>
                            </tr>
                            <tr>
                                <th>Product</th>
                                <td>${escapeHtml(data.product)}</td>
                            </tr>
                            <tr>
                                <th>Vendor ID</th>
                                <td>${escapeHtml(data.vendor_id)}</td>
                            </tr>
                            <tr>
                                <th>Product ID</th>
                                <td>${escapeHtml(data.product_id)}</td>
                            </tr>
                            <tr>
                                <th>Category</th>
                                <td>
                                    <span class="badge bg-primary">${escapeHtml(data.category)}</span>
                                </td>
                            </tr>
                            <tr>
                                <th>Subcategory</th>
                                <td>
                                    ${data.subcategory ? `<span class="badge bg-secondary">${escapeHtml(data.subcategory)}</span>` : 'N/A'}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-lg-6">
                        <h3>Metadata</h3>
                        <table class="table table-striped pattern-metadata-table">
                            <tr>
                                <th>Author</th>
                                <td>${escapeHtml(data.all_versions && data.all_versions[0] ? data.all_versions[0].metadata.author : 'N/A')}</td>
                            </tr>
                            <tr>
                                <th>Created</th>
                                <td>${escapeHtml(data.all_versions && data.all_versions[0] ? data.all_versions[0].metadata.created_at : 'N/A')}</td>
                            </tr>
                            <tr>
                                <th>Updated</th>
                                <td>${escapeHtml(data.all_versions && data.all_versions[0] ? data.all_versions[0].metadata.updated_at : 'N/A')}</td>
                            </tr>
                            <tr>
                                <th>Source</th>
                                <td>${escapeHtml(data.all_versions && data.all_versions[0] ? data.all_versions[0].metadata.source : 'N/A')}</td>
                            </tr>
                            <tr>
                                <th>License</th>
                                <td>${escapeHtml(data.all_versions && data.all_versions[0] ? data.all_versions[0].metadata.license : 'N/A')}</td>
                            </tr>
                            <tr>
                                <th>Severity</th>
                                <td>
                                    ${data.all_versions && data.all_versions[0] && data.all_versions[0].metadata.severity ? 
                                      `<span class="badge bg-${getSeverityClass(data.all_versions[0].metadata.severity)}">${escapeHtml(data.all_versions[0].metadata.severity)}</span>` : 
                                      'N/A'}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <h3>All Versions Patterns (${data.all_versions ? data.all_versions.length : 0})</h3>
                        ${data.all_versions && data.all_versions.length > 0 ? `
                            <div class="accordion" id="patternsAccordion">
                                ${data.all_versions.map((pattern, index) => `
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading${index}">
                                            <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" 
                                                    type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#collapse${index}" 
                                                    aria-expanded="${index === 0 ? 'true' : 'false'}" 
                                                    aria-controls="collapse${index}">
                                                <strong>${escapeHtml(pattern.name || 'Unnamed Pattern')}</strong>
                                                <span class="ms-2">
                                                    <span class="badge bg-primary">Priority: ${pattern.priority}</span>
                                                    <span class="badge bg-success">Confidence: ${pattern.confidence}</span>
                                                    <span class="badge bg-info">Version Group: ${pattern.version_group}</span>
                                                </span>
                                            </button>
                                        </h2>
                                        <div id="collapse${index}" 
                                             class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                                             aria-labelledby="heading${index}" 
                                             data-bs-parent="#patternsAccordion">
                                            <div class="accordion-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h5>Pattern</h5>
                                                        <pre class="bg-light p-3">${escapeHtml(pattern.pattern)}</pre>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h5>Details</h5>
                                                        <table class="table table-striped">
                                                            <tr>
                                                                <th>Priority</th>
                                                                <td>${pattern.priority}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>Confidence</th>
                                                                <td>${pattern.confidence}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>Version Group</th>
                                                                <td>${pattern.version_group}</td>
                                                            </tr>
                                                        </table>
                                                        
                                                        <h5 class="mt-3">Metadata</h5>
                                                        <table class="table table-striped">
                                                            <tr>
                                                                <th>Description</th>
                                                                <td>${escapeHtml(pattern.metadata.description || 'N/A')}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>Tags</th>
                                                                <td>
                                                                    ${pattern.metadata.tags && pattern.metadata.tags.length > 0 ? 
                                                                      pattern.metadata.tags.map(tag => `<span class="badge bg-secondary me-1">${escapeHtml(tag)}</span>`).join('') : 
                                                                      'None'}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <th>CVSS Score</th>
                                                                <td>${pattern.metadata.cvss_score || 'N/A'}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>CWE IDs</th>
                                                                <td>
                                                                    ${pattern.metadata.cwe_ids && pattern.metadata.cwe_ids.length > 0 ? 
                                                                      pattern.metadata.cwe_ids.map(cwe => `<span class="badge bg-warning me-1">${escapeHtml(cwe)}</span>`).join('') : 
                                                                      'None'}
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </div>
                                                
                                                ${pattern.metadata.test_cases && pattern.metadata.test_cases.length > 0 ? `
                                                    <div class="row mt-3">
                                                        <div class="col-12">
                                                            <h5>Test Cases</h5>
                                                            <div class="table-responsive">
                                                                <table class="table table-striped">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Input</th>
                                                                            <th>Expected Version</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        ${pattern.metadata.test_cases.map(testCase => `
                                                                            <tr>
                                                                                <td><pre class="mb-0 bg-light p-2">${escapeHtml(testCase.input)}</pre></td>
                                                                                <td>${escapeHtml(testCase.expected_version || 'N/A')}</td>
                                                                            </tr>
                                                                        `).join('')}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="alert alert-info">No patterns available for this technology</div>
                        `}
                    </div>
                </div>
            `;
            
            document.getElementById('pattern-content').innerHTML = patternHtml;
        })
        .catch(error => {
            console.error('Error fetching pattern details:', error);
            document.getElementById('pattern-content').innerHTML = 
                `<div class="alert alert-danger">Error loading pattern: ${error.message}</div>`;
        });
    
    // Severity class helper
    function getSeverityClass(severity) {
        switch (severity.toLowerCase()) {
            case 'critical': return 'danger';
            case 'high': return 'danger';
            case 'medium': return 'warning';
            case 'low': return 'info';
            default: return 'secondary';
        }
    }
    
    // Test pattern functionality
    document.getElementById('test-pattern-btn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('testPatternModal'));
        modal.show();
    });
    
    document.getElementById('run-test-btn').addEventListener('click', function() {
        const testInput = document.getElementById('test-input').value;
        if (!testInput.trim()) {
            document.getElementById('test-results').innerHTML = 
                '<div class="alert alert-warning">Please enter some text to test</div>';
            return;
        }
        
        // Show loading indicator
        document.getElementById('test-results').innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Testing...</span>
                </div>
                <p class="mt-2">Testing pattern...</p>
            </div>
        `;
        
        // In a real implementation, this would call the pattern matching API
        // For now, we'll simulate a result
        setTimeout(() => {
            const resultsHtml = `
                <div class="alert alert-success">
                    <h5>Test Results</h5>
                    <p>Pattern matched successfully!</p>
                    <ul>
                        <li><strong>Matched Text:</strong> Server: Apache/2.4.41 (Ubuntu)</li>
                        <li><strong>Extracted Version:</strong> 2.4.41</li>
                        <li><strong>Confidence:</strong> 90%</li>
                    </ul>
                </div>
            `;
            document.getElementById('test-results').innerHTML = resultsHtml;
        }, 1000);
    });
    
    document.getElementById('clear-test-btn').addEventListener('click', function() {
        document.getElementById('test-input').value = '';
        document.getElementById('test-results').innerHTML = '';
    });
    
    // Copy pattern functionality
    document.getElementById('copy-pattern-btn').addEventListener('click', function() {
        // In a real implementation, this would copy the pattern data to clipboard
        // For now, we'll just show a success message
        const modal = new bootstrap.Modal(document.getElementById('copySuccessModal'));
        modal.show();
        
        // Auto-hide the modal after 1.5 seconds
        setTimeout(() => {
            modal.hide();
        }, 1500);
    });
</script>
{% endblock %}
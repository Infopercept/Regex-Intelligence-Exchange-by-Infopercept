{% extends "base.html" %}

{% block title %}Search Patterns - Regex Intelligence Exchange{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-search"></i> Search Patterns</h1>
        <p class="lead">Search our comprehensive database of technology fingerprinting patterns.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-filter"></i> Filters
            </div>
            <div class="card-body">
                <form id="search-filters">
                    <div class="mb-3">
                        <label for="search-query" class="form-label">Search Query</label>
                        <input type="text" class="form-control" id="search-query" placeholder="Enter search terms...">
                        <div class="form-text">Search by vendor, product, category, or technology name</div>
                    </div>
                    <div class="mb-3">
                        <label for="category-filter" class="form-label">Category</label>
                        <select class="form-select" id="category-filter">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="vendor-filter" class="form-label">Vendor</label>
                        <select class="form-select" id="vendor-filter">
                            <option value="">All Vendors</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> Search
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list"></i> Search Results</span>
                <div>
                    <span id="result-count">0</span> patterns found
                </div>
            </div>
            <div class="card-body">
                <div id="search-results">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading patterns...</p>
                    </div>
                </div>
                <nav id="pagination-controls" class="mt-3 d-none">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled" id="prev-page">
                            <a class="page-link" href="#" tabindex="-1">Previous</a>
                        </li>
                        <li class="page-item active" id="page-1">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item" id="next-page">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let currentPage = 1;
    
    // Fetch categories and vendors for filters
    fetch('/api/patterns')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Extract unique categories and vendors from patterns
            const categories = [...new Set(data.map(pattern => pattern.category).filter(Boolean))].sort();
            const vendors = [...new Set(data.map(pattern => pattern.vendor).filter(Boolean))].sort();
            
            const categorySelect = document.getElementById('category-filter');
            if (categorySelect) {
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }
            
            const vendorSelect = document.getElementById('vendor-filter');
            if (vendorSelect) {
                vendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor;
                    option.textContent = vendor;
                    vendorSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading filter options:', error);
            // Show notification to user
            const resultsContainer = document.getElementById('search-results');
            if (resultsContainer) {
                resultsContainer.innerHTML = `<div class="alert alert-danger">Error loading filter options: ${error.message}</div>`;
            }
        });
    
    // Search functionality
    document.getElementById('search-filters').addEventListener('submit', function(e) {
        e.preventDefault();
        currentPage = 1;
        performSearch();
    });
    
    // Add real-time search with debounce
    let searchTimeout;
    const searchInput = document.getElementById('search-query');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 300); // 300ms debounce
        });
    }
    
    // Also trigger search when filters change
    const categoryFilter = document.getElementById('category-filter');
    const vendorFilter = document.getElementById('vendor-filter');
    
    if (categoryFilter) {
        categoryFilter.addEventListener('change', performSearch);
    }
    
    if (vendorFilter) {
        vendorFilter.addEventListener('change', performSearch);
    }
    
    function performSearch(page = 1) {
        const query = document.getElementById('search-query').value;
        const category = document.getElementById('category-filter').value;
        const vendor = document.getElementById('vendor-filter').value;
        
        // Build query parameters
        const params = new URLSearchParams();
        if (query) params.append('q', query);
        if (category) params.append('category', category);
        if (vendor) params.append('vendor', vendor);
        
        // Show loading indicator
        const resultsContainer = document.getElementById('search-results');
        if (resultsContainer) {
            resultsContainer.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Searching patterns...</p>
                </div>
            `;
        }
        
        fetch(`/api/patterns/search?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displayResults(data, data.length);
            })
            .catch(error => {
                console.error('Error searching patterns:', error);
                if (resultsContainer) {
                    resultsContainer.innerHTML = `<div class="alert alert-danger">Error searching patterns: ${error.message}</div>`;
                }
            });
    }
    
    function displayResults(patterns, total) {
        const resultCountElement = document.getElementById('result-count');
        if (resultCountElement) {
            resultCountElement.textContent = total;
        }
        
        const resultsContainer = document.getElementById('search-results');
        if (!resultsContainer) return;
        
        if (patterns.length === 0) {
            resultsContainer.innerHTML = `
                <div class="alert alert-info">
                    <h5>No Patterns Found</h5>
                    <p>No technology patterns match your search criteria. Try adjusting your filters or search terms.</p>
                </div>
            `;
            return;
        }
        
        const resultsHtml = `
            <div class="list-group">
                ${patterns.map(pattern => `
                    <a href="/pattern/${pattern.vendor_id}/${pattern.product_id}" 
                       class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${pattern.vendor} - ${pattern.product}</h5>
                            <small class="text-muted">${pattern.pattern_count} pattern${pattern.pattern_count !== 1 ? 's' : ''}</small>
                        </div>
                        <p class="mb-1">
                            <span class="badge bg-primary">${pattern.category}</span>
                            ${pattern.subcategory ? `<span class="badge bg-secondary ms-1">${pattern.subcategory}</span>` : ''}
                        </p>
                        <small class="text-muted">Vendor ID: ${pattern.vendor_id} | Product ID: ${pattern.product_id}</small>
                    </a>
                `).join('')}
            </div>
        `;
        
        resultsContainer.innerHTML = resultsHtml;
    }
    
    // Initial search
    setTimeout(performSearch, 100);
</script>
{% endblock %}